"""Experimaestro SLURM launcher configuration.

Cluster: {{ cluster_name }}
Generated by: experimaestro launchers slurm generate

Configuration file: {{ config_file }}

Configured partitions (by priority):
{%- for p in partitions %}
  - {{ p.name }}: {{ p.cpus }} CPUs, {{ (p.memory_bytes / (1024**3)) | round(0) | int }} GB RAM
    {%- if p.gpus > 0 %}, {{ p.gpus }}x {{ p.gpu_type or "GPU" }} ({{ (p.gpu_memory_bytes / (1024**3)) | round(0) | int }} GB each){%- endif %}
    {%- if p.qos %} [QoS: {{ p.qos }}]{%- endif %}

{%- endfor %}
"""

from typing import Set
from experimaestro.launcherfinder import (
    HostRequirement,
    HostSpecification,
    CPUSpecification,
    CudaSpecification,
)
from experimaestro.launchers.slurm import SlurmLauncher, SlurmOptions
from experimaestro.connectors.local import LocalConnector


# Partition configurations (ordered by priority, highest first)
PARTITIONS = [
{%- for p in partitions %}
    {
        "name": "{{ p.name }}",
        "priority": {{ p.priority }},
        "cpus": {{ p.cpus }},
        "memory_bytes": {{ p.memory_bytes }},
        "gpus": {{ p.gpus }},
        "gpu_type": {{ '"%s"' % p.gpu_type if p.gpu_type else 'None' }},
        "gpu_memory_bytes": {{ p.gpu_memory_bytes }},
        "time_limit_seconds": {{ p.time_limit_seconds }},
        "qos": {{ '"%s"' % p.qos if p.qos else 'None' }},
    },
{%- endfor %}
]

# Default SLURM settings
DEFAULT_ACCOUNT = {{ '"%s"' % default_account if default_account else 'None' }}
CONSIDER_PRIORITY = {{ consider_priority }}


def _get_partition_spec(partition: dict) -> HostSpecification:
    """Build HostSpecification for a partition."""
    accelerators = []
    if partition["gpus"] > 0:
        for _ in range(partition["gpus"]):
            accelerators.append(
                CudaSpecification(memory=partition["gpu_memory_bytes"])
            )

    return HostSpecification(
        cpu=CPUSpecification(
            memory=partition["memory_bytes"],
            cores=partition["cpus"],
        ),
        accelerators=accelerators,
    )


def find_launcher(requirements: HostRequirement, tags: Set[str] = set()):
    """Find a SLURM launcher for the given requirements.

    Args:
        requirements: Host requirements (CPU memory, GPU memory, duration, etc.)
        tags: Optional tags to filter launchers

    Returns:
        A SlurmLauncher configured for the requirements, or None if no partition matches
    """
    connector = LocalConnector.instance()
    best_match = None
    best_partition = None
    best_priority = -1

    # Try each partition in priority order
    for partition in PARTITIONS:
        spec = _get_partition_spec(partition)
        match = requirements.match(spec)

        if match is None:
            continue

        priority = partition["priority"]

        # Select best match based on priority
        if CONSIDER_PRIORITY:
            if priority > best_priority:
                best_match = match
                best_partition = partition
                best_priority = priority
        else:
            # First match wins (partitions already sorted by priority)
            best_match = match
            best_partition = partition
            break

    if best_match is None or best_partition is None:
        return None

    # Build SlurmOptions
    req = best_match.requirement

    # Calculate resources needed
    gpus_needed = len(req.accelerators) if req.accelerators else 0
    cpus_needed = req.cpu.cores if req.cpu and req.cpu.cores else None
    mem_needed = req.cpu.memory if req.cpu and req.cpu.memory else None

    # Get duration for time limit
    duration_seconds = None
    if hasattr(req, "duration") and req.duration:
        duration_seconds = req.duration

    # Build options
    options = SlurmOptions(
        partition=best_partition["name"],
{%- if default_account %}
        account=DEFAULT_ACCOUNT,
{%- endif %}
    )

    # Set QoS if configured for this partition
    if best_partition["qos"]:
        options.qos = best_partition["qos"]

    # Set GPU count if needed
    if gpus_needed > 0:
        options.gpus = gpus_needed

    # Set memory if specified (convert bytes to MB for SLURM)
    if mem_needed:
        options.mem = f"{mem_needed // (1024**2)}M"

    # Set CPU count if specified
    if cpus_needed:
        options.cpus_per_task = str(cpus_needed)

    # Set time limit if specified
    if duration_seconds:
        options.time = SlurmOptions.format_time(duration_seconds)

    return SlurmLauncher(connector=connector, options=options)
